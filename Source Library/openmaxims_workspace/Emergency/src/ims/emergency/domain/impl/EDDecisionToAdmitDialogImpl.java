//#############################################################################
//#                                                                           #
//#  Copyright (C) <2015>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#  IMS MAXIMS provides absolutely NO GUARANTEE OF THE CLINICAL SAFTEY of    #
//#  this program.  Users of this software do so entirely at their own risk.  #
//#  IMS MAXIMS only ensures the Clinical Safety of unaltered run-time        #
//#  software that it builds, deploys and maintains.                          #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Cornel Ventuneac using IMS Development Environment (version 1.80 build 4785.23502)
// Copyright (C) 1995-2013 IMS MAXIMS. All rights reserved.

package ims.emergency.domain.impl;

import ims.admin.domain.OrganisationAndLocation;
import ims.admin.domain.impl.OrganisationAndLocationImpl;
import ims.core.admin.domain.objects.CareContext;
import ims.core.admin.domain.objects.EpisodeOfCare;
import ims.core.admin.pas.domain.objects.AllocatedWardHistory;
import ims.core.admin.pas.domain.objects.PASEvent;
import ims.core.admin.pas.domain.objects.PendingEmergencyAdmission;
import ims.core.admin.pas.vo.PendingEmergencyAdmissionRefVo;
import ims.core.admin.vo.CareContextRefVo;
import ims.core.admin.vo.EpisodeOfCareRefVo;
import ims.core.configuration.domain.objects.AppUser;
import ims.core.configuration.vo.AppUserRefVo;
import ims.core.patient.domain.objects.Patient;
import ims.core.resource.place.domain.objects.Location;
import ims.core.resource.place.vo.LocationRefVo;
import ims.core.vo.CareContextShortVo;
import ims.core.vo.EpisodeofCareShortVo;
import ims.core.vo.LocShortVoCollection;
import ims.core.vo.LocationLiteVo;
import ims.core.vo.LocationLiteVoCollection;
import ims.core.vo.ServiceLiteVoCollection;
import ims.core.vo.domain.CareContextShortVoAssembler;
import ims.core.vo.domain.EpisodeofCareShortVoAssembler;
import ims.core.vo.domain.LocationLiteVoAssembler;
import ims.core.vo.domain.PasEventForPendingEmergencyAdmissionShortVoAssembler;
import ims.core.vo.domain.PatientShortAssembler;
import ims.core.vo.domain.ServiceLiteVoAssembler;
import ims.core.vo.lookups.ServiceCategory;
import ims.domain.DomainFactory;
import ims.domain.exceptions.StaleObjectException;
import ims.domain.exceptions.UniqueKeyViolationException;
import ims.emergency.domain.base.impl.BaseEDDecisionToAdmitDialogImpl;
import ims.emergency.domain.objects.ReferralToSpecTeam;
import ims.emergency.domain.objects.Tracking;
import ims.emergency.helper.EmergencyHelper;
import ims.emergency.helper.IEmergencyHelper;
import ims.emergency.vo.BedAvailabilityForTrackVo;
import ims.emergency.vo.PendingEmergencyAdmissionShortVo;
import ims.emergency.vo.ReferralToSpecialtyTeamVo;
import ims.emergency.vo.TrackingforDecisionToAdmitDialogVo;
import ims.emergency.vo.domain.PendingEmergencyAdmissionShortVoAssembler;
import ims.emergency.vo.domain.ReferralToSpecialtyTeamVoAssembler;
import ims.emergency.vo.domain.TrackingforDecisionToAdmitDialogVoAssembler;
import ims.framework.exceptions.CodingRuntimeException;
import ims.framework.interfaces.ILocation;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

public class EDDecisionToAdmitDialogImpl extends BaseEDDecisionToAdmitDialogImpl
{

	private static final long serialVersionUID = 1L;

	public ims.emergency.vo.TrackingforDecisionToAdmitDialogVo getTrackingForClinicianWorklistAndTriageVo(ims.emergency.vo.TrackingRefVo trackingRef)
	{
		
		if(trackingRef == null || trackingRef.getID_Tracking() == null)
			throw new CodingRuntimeException("Cannot get Tracking record for a null Tracking Id.");
		
		return TrackingforDecisionToAdmitDialogVoAssembler.create((Tracking) getDomainFactory().getDomainObject(Tracking.class, trackingRef.getID_Tracking()));
	
	}
	
	public PendingEmergencyAdmissionShortVo save(PendingEmergencyAdmissionShortVo record, BedAvailabilityForTrackVo bedAvailability, TrackingforDecisionToAdmitDialogVo tracking, ReferralToSpecialtyTeamVo referralToSpecialtyToBeSaved, Boolean hasWardChanged) throws StaleObjectException, UniqueKeyViolationException //WDEV-16777 
	{
		if( record == null)
			throw new CodingRuntimeException("Cannot save a null PendingEmergencyAdmission record.");
		
		if( tracking == null)
			throw new CodingRuntimeException("Cannot save a null Tracking record.");
		
		if(!tracking.isValidated())
			throw new CodingRuntimeException("Tracking record is not validated.");
		
		DomainFactory factory = getDomainFactory();
		
		//WDEV-16777
		if (referralToSpecialtyToBeSaved!=null)
		{
			ReferralToSpecTeam domainReferralToSpecialtyToBeSaved = ReferralToSpecialtyTeamVoAssembler.extractReferralToSpecTeam(factory, referralToSpecialtyToBeSaved);
			factory.save(domainReferralToSpecialtyToBeSaved);	
			tracking.setCurrentReferral(null);			
		
			Tracking doTracking = TrackingforDecisionToAdmitDialogVoAssembler.extractTracking(factory, tracking);
			factory.save(doTracking);
			tracking=TrackingforDecisionToAdmitDialogVoAssembler.create(doTracking);
			tracking.validate();
	
		}
		//WDEV-20988
		PendingEmergencyAdmission doPendingEmergencyAdmission = PendingEmergencyAdmissionShortVoAssembler.extractPendingEmergencyAdmission(factory, record);
		if (hasWardChanged)
		{
			AllocatedWardHistory doAllocWardHist = new AllocatedWardHistory();
			doAllocWardHist.setAllocatedWard(doPendingEmergencyAdmission.getAllocatedWard());
			doAllocWardHist.setAllocatedWardDateTime(new Date());		
			if(getLoggedInUser() != null)
				doAllocWardHist.setAllocatingUser((AppUser) getDomainFactory().getDomainObject((AppUserRefVo) getLoggedInUser()));
			if (doPendingEmergencyAdmission.getAllocatedWardHistory() == null)
				doPendingEmergencyAdmission.setAllocatedWardHistory(new java.util.HashSet());
			doPendingEmergencyAdmission.getAllocatedWardHistory().add(doAllocWardHist);
		}
		if (doPendingEmergencyAdmission.getId() != null && bedAvailability != null && bedAvailability.getWardIsNotNull()) 
		{
			doPendingEmergencyAdmission.setAllocatedWard(LocationLiteVoAssembler.extractLocation(factory, bedAvailability.getWard()));
		}			
		
		if (record.getPasEventIsNotNull() && !record.getPasEvent().getID_PASEventIsNotNull())				
		{			
			PASEvent doPASEvent = PasEventForPendingEmergencyAdmissionShortVoAssembler.extractPASEvent(factory, record.getPasEvent());
			factory.save(doPASEvent);			
			doPendingEmergencyAdmission.setPasEvent(doPASEvent);			
		}
		//WDEV-20988  --- end
		//WDEV-23401
//		factory.save(doPendingEmergencyAdmission); //WDEV-23401
		
		tracking.setBedAvailability(bedAvailability);
		Tracking doTracking = TrackingforDecisionToAdmitDialogVoAssembler.extractTracking(factory, tracking);
		doTracking.setAssociatedPendingEmergencyAdmission(doPendingEmergencyAdmission);
		factory.save(doTracking);

		factory.save(doPendingEmergencyAdmission); //WDEV-234401

		return PendingEmergencyAdmissionShortVoAssembler.create(doPendingEmergencyAdmission);
	}

	public ims.core.vo.PatientShort getPatientShort(ims.core.patient.vo.PatientRefVo patRef)
	{
		if( patRef == null || patRef.getID_Patient() == null)
			throw new CodingRuntimeException("Cannot get Patient record for a null Patient Id.");
		
		return PatientShortAssembler.create((Patient) getDomainFactory().getDomainObject(Patient.class, patRef.getID_Patient()));
	
	}

	
	
	//wdev-17254
	public TrackingforDecisionToAdmitDialogVo saveRemoveBed(TrackingforDecisionToAdmitDialogVo tracking, PendingEmergencyAdmissionShortVo pending) throws StaleObjectException, UniqueKeyViolationException
	{
		if( tracking == null )
			throw new CodingRuntimeException("Cannot save a null TrackingForClinicianWorklistAndTriageVo  record");
		
			
		
		DomainFactory factory = getDomainFactory();
		
		PendingEmergencyAdmission doPendingEmergencyAdmission = null;
		if( pending != null )
		{
			doPendingEmergencyAdmission = PendingEmergencyAdmissionShortVoAssembler.extractPendingEmergencyAdmission(factory, pending);
			//WDEV-234401
//			factory.save(doPendingEmergencyAdmission); //WDEV-234401
		}
		
		Tracking doTracking = TrackingforDecisionToAdmitDialogVoAssembler.extractTracking(factory, tracking);
		
		if( doTracking != null && doPendingEmergencyAdmission != null)
			doTracking.setAssociatedPendingEmergencyAdmission(doPendingEmergencyAdmission);
		
		factory.save(doTracking);
		
		factory.save(doPendingEmergencyAdmission); //WDEV-234401
		
		return TrackingforDecisionToAdmitDialogVoAssembler.create(doTracking);
		
	}

	//wdev-17380
	public EpisodeofCareShortVo getEpisodeOfCare(EpisodeOfCareRefVo episodeRef) 
	{
		if( episodeRef == null || episodeRef.getID_EpisodeOfCare() == null)
			throw new CodingRuntimeException("Cannot get Episode Of Care record for a null EpisodeOfCareRefVo");
		
		return EpisodeofCareShortVoAssembler.create((EpisodeOfCare) getDomainFactory().getDomainObject(EpisodeOfCare.class, episodeRef.getID_EpisodeOfCare()));
	
	}

	//wdev-17380
	public CareContextShortVo getCareContextShort(CareContextRefVo careContextRef) 
	{
		if( careContextRef == null || careContextRef.getID_CareContext() == null)
			throw new CodingRuntimeException("Cannot get Care Context record for a null CareContextRefVo");
		return CareContextShortVoAssembler.create((CareContext) getDomainFactory().getDomainObject(CareContext.class, careContextRef.getID_CareContext()));
			
	}

	//wdev-17488
	public LocationLiteVo getLocationLiteVo(LocationRefVo locRef) 
	{
		if( locRef == null || locRef.getID_Location() == null)
			throw new CodingRuntimeException("Cannot get Location record for a null LocationRefVo");
		return LocationLiteVoAssembler.create((Location) getDomainFactory().getDomainObject(Location.class, locRef.getID_Location()));
			
	}

	//WDEV-17615
	public LocationLiteVo getCurrentHospital(ILocation currentLocation)
	{
		IEmergencyHelper impl = (IEmergencyHelper)getDomainImpl(EmergencyHelper.class);
		return impl.getCurrentHospital(currentLocation);
	}

	//WDEV-20388
	public LocationLiteVoCollection listActiveHospitals()
	{
		OrganisationAndLocation impl = (OrganisationAndLocation) getDomainImpl(OrganisationAndLocationImpl.class);
		return impl.listActiveHospitalsLite();
	}

	//WDEV-20388, WDEV-21201
	public LocShortVoCollection listActiveWardsForHospital(LocationRefVo hospitalRef, String value)
	{
		OrganisationAndLocation impl = (OrganisationAndLocation) getDomainImpl(OrganisationAndLocationImpl.class);
		return impl.listActiveWardsForHospitalByName(hospitalRef, value);
	}
	
	//WDEV-20388
	public TrackingforDecisionToAdmitDialogVo getTrackingByPendingEmergencyAdmission(PendingEmergencyAdmissionRefVo pendingEmergencyAdmissionRef)
	{
		if (pendingEmergencyAdmissionRef == null || pendingEmergencyAdmissionRef.getID_PendingEmergencyAdmission() == null)
			throw new CodingRuntimeException("pendingemergencyadmissionRef is null or id not provided ");
		
		String hql = "select t1_1 from Tracking as t1_1 left join t1_1.associatedPendingEmergencyAdmission as p1_1 where p1_1.id = " + pendingEmergencyAdmissionRef.getID_PendingEmergencyAdmission() + " and (t1_1.isRIE is null  or t1_1.isRIE = 0) order by t1_1.systemInformation.creationDateTime desc ";
		List lstTracking = getDomainFactory().find(hql);
		
		if( lstTracking == null || lstTracking.size() == 0)
			return null;
		
		return TrackingforDecisionToAdmitDialogVoAssembler.create((Tracking)lstTracking.get(0));
		
	}

	//WDEV-20722, WDEV-21201
	@Override
	public ServiceLiteVoCollection listActiveClinicalServices(String value) 
	{
		DomainFactory factory = getDomainFactory();
		
		ArrayList<String> paramName = new ArrayList<String>();
		ArrayList<Object> paramValue = new ArrayList<Object>();

		StringBuilder hql = new StringBuilder("FROM Service service WHERE service.isActive = :isActive AND service.serviceCategory.id = :serviceCategoryID ");
		
		paramName.add("isActive");				paramValue.add(Boolean.TRUE);
		paramName.add("serviceCategoryID");		paramValue.add(ServiceCategory.CLINICAL.getID());
		
		if(value != null)
		{
			hql.append(" and service.upperName LIKE :SERVICE_NAME");
			paramName.add("SERVICE_NAME");
			paramValue.add("%" + value + "%");
		}
		
		return ServiceLiteVoAssembler.createServiceLiteVoCollectionFromService(factory.find(hql.toString(), paramName, paramValue));
	}
	//WDEV-20722 ends here
}
