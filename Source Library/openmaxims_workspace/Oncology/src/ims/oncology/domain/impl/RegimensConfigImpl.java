//#############################################################################
//#                                                                           #
//#  Copyright (C) <2015>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#  IMS MAXIMS provides absolutely NO GUARANTEE OF THE CLINICAL SAFTEY of    #
//#  this program.  Users of this software do so entirely at their own risk.  #
//#  IMS MAXIMS only ensures the Clinical Safety of unaltered run-time        #
//#  software that it builds, deploys and maintains.                          #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Cornel Ventuneac using IMS Development Environment (version 1.80 build 4080.23374)
// Copyright (C) 1995-2011 IMS MAXIMS. All rights reserved.

package ims.oncology.domain.impl;

import ims.core.vo.lookups.PreActiveActiveInactiveStatus;
import ims.domain.DomainFactory;
import ims.domain.DomainObject;
import ims.domain.exceptions.UniqueKeyViolationException;
import ims.domain.lookups.LookupInstance;
import ims.framework.exceptions.CodingRuntimeException;
import ims.oncology.configuration.domain.objects.ChemoRegimensConfig;
import ims.oncology.configuration.vo.ChemoRegimensConfigRefVo;
import ims.oncology.domain.base.impl.BaseRegimensConfigImpl;
import ims.oncology.forms.regimensconfig.Logic.SearchPattern;
import ims.oncology.vo.ChemoRegimensConfigVoCollection;
import ims.oncology.vo.domain.ChemoRegimensConfigVoAssembler;
import ims.oncology.vo.lookups.RegimenAcronym;
import ims.oncology.vo.lookups.RegimenAcronymCollection;
import ims.vo.LookupInstVo;

import java.util.ArrayList;
import java.util.List;

public class RegimensConfigImpl extends BaseRegimensConfigImpl
{

	private static final long serialVersionUID = 1L;

	/**
	 * WDEV-12790
	 * Function used to search data base for ChemoRegimensConfig records based on a search criteria and / or an ID
	 * - will return all records matching search criteria (Regimen name & active/inactive status)
	 * - will return the ChemoRegimensConfig records with the ID - regardless if it matches or not the search criteria (Regimen name & active/inactive status)
	 */
	public ChemoRegimensConfigVoCollection listChemoRegimensConfig(ChemoRegimensConfigRefVo regimenConfig, String regimen, Boolean activeOnly, Integer searchPattern)
	{
		// Check if any data was passed to search function
		// If no data is passed then return null
		if ((regimenConfig == null || !regimenConfig.getID_ChemoRegimensConfigIsNotNull()) && (regimen == null || regimen.length() == 0))
			return null;
		
		// Build query tools
		StringBuilder query = new StringBuilder();
		String conditional = "";

		// Start the query
		query.append("SELECT chem FROM ChemoRegimensConfig AS chem WHERE ");
		
		// Search criteria part of the query
		if (regimen != null && regimen.length() > 0)
		{
			// Add the status part of the query
    		if (Boolean.TRUE.equals(activeOnly))
    		{
    			query.append("(chem.status.id = ").append(PreActiveActiveInactiveStatus.ACTIVE.getID());
        		query.append(" AND ");
    		}

    		// Add the Regimen name part to the query
			query.append(" UPPER(chem.regimen.text) LIKE ");
			// Determine how the regimen name should be searched after
			switch (SearchPattern.getSearchPattern(searchPattern))
			{
				case BEGINS:
					query.append("'").append(regimen.toUpperCase()).append("%'").append(")");
					break;

				case CONTAINS:
					query.append("'%").append(regimen.toUpperCase()).append("%'").append(")");
					break;

				case EXACT:
					query.append("'").append(regimen.toUpperCase()).append("'").append(")");
					break;
			}
			
			// Prepare for selected item
			conditional = " OR ";
		}
		
		// Add the selected ChemoRegimensConfig part to query
		if (regimenConfig != null && regimenConfig.getID_ChemoRegimensConfigIsNotNull())
		{
			query.append(conditional);
			query.append(" chem.id = ").append(regimenConfig.getID_ChemoRegimensConfig().toString());
		}
		
		// Add the sort order part to query
		query.append(" ORDER BY chem.regimen.text");
		
		// Query database server and return results
		return ChemoRegimensConfigVoAssembler.createChemoRegimensConfigVoCollectionFromChemoRegimensConfig(getDomainFactory().find(query.toString()));
	}

	public ims.oncology.vo.ChemoRegimensConfigVo getChemoRegimensConfig(ims.oncology.configuration.vo.ChemoRegimensConfigRefVo record)
	{
		if(record == null || record.getID_ChemoRegimensConfig() == null)
			return null;
		
		return ChemoRegimensConfigVoAssembler.create((ChemoRegimensConfig) getDomainFactory().getDomainObject(ChemoRegimensConfig.class, record.getID_ChemoRegimensConfig()));
	}

	public ims.oncology.vo.ChemoRegimensConfigVo save(ims.oncology.vo.ChemoRegimensConfigVo record) throws ims.domain.exceptions.DomainInterfaceException, ims.domain.exceptions.StaleObjectException, ims.domain.exceptions.UniqueKeyViolationException
	{
		if(record == null)
			throw new CodingRuntimeException("Can not save a null ChemoRegimensConfigVo");
		
		if(!record.isValidated())
			throw new CodingRuntimeException("ChemoRegimensConfigVo must be validated before save.");
		
		DomainFactory factory = getDomainFactory();

		// WDEV-12375
		// Check for Regimen to be unique (check on new and on edit - exclude the current record)
		// This is applied only for active records; inactive records or RIE records are not to be considered for this constraint
		if (PreActiveActiveInactiveStatus.ACTIVE.equals(record.getStatus()))
		{
			StringBuilder query = new StringBuilder();
			query.append("select regi from ChemoRegimensConfig as regi where regi.isRIE is null");

			if (record.getID_ChemoRegimensConfigIsNotNull())
			{
				query.append(" and regi.id <> "); query.append(record.getID_ChemoRegimensConfig().toString());
				query.append(" and regi.regimen.id = "); query.append(record.getRegimen().getID());
				query.append(" and regi.status.id = "); query.append(PreActiveActiveInactiveStatus.ACTIVE.getID());
			}
			else
			{
				query.append(" and regi.regimen.id = "); query.append(record.getRegimen().getID());
				query.append(" and regi.status.id = "); query.append(PreActiveActiveInactiveStatus.ACTIVE.getID());
			}

			DomainObject result = factory.findFirst(query.toString());

			if (result != null)
				throw new UniqueKeyViolationException("Another active Regimen Configuration with the same Regimen already exists in the system");
		}
		
		ChemoRegimensConfig doRecord = ChemoRegimensConfigVoAssembler.extractChemoRegimensConfig(factory, record);
		factory.save(doRecord);
				
		return ChemoRegimensConfigVoAssembler.create(doRecord);
	}

	public RegimenAcronymCollection listUnusedRegimen(String name, RegimenAcronym regimen)
	{
		StringBuilder query = new StringBuilder();
		ArrayList<String> paramNames = new ArrayList<String>();
		ArrayList<Object> paramValues = new ArrayList<Object>();
		
		query.append("select lkp from LookupInstance as lkp where lkp.type.id = :TYPE and lkp.active = 1 and lkp.id not in (select chemo.regimen.id from ChemoRegimensConfig as chemo where chemo.status.id = :ACTIVE)");
		
		paramNames.add("TYPE"); paramValues.add(RegimenAcronym.TYPE_ID);
		paramNames.add("ACTIVE"); paramValues.add(PreActiveActiveInactiveStatus.ACTIVE.getID());
		
		if (name != null)
		{
			query.append(" and UPPER(lkp.text) like :NAME");
			
			paramNames.add("NAME"); paramValues.add(name.toUpperCase() + "%");
		}
		
		if (regimen != null)
		{
			query.append(" or lkp.id = :USED");
			
			paramNames.add("USED"); paramValues.add(regimen.getID());
		}
		
		List searchResults = getDomainFactory().find(query.toString(), paramNames, paramValues);
		
		if (searchResults == null || searchResults.size() == 0)
			return null;
		
		RegimenAcronymCollection results = new RegimenAcronymCollection();
		
		for (int i = 0; i < searchResults.size(); i++)
		{
			if (searchResults.get(i) instanceof LookupInstance)
			{
				LookupInstVo regimenInstance = getLookupService().getLookupInstance(RegimenAcronym.class, RegimenAcronym.TYPE_ID, ((LookupInstance)searchResults.get(i)).getId());
				results.add(regimenInstance);
			}
		}
		
		return results;
	}
}
