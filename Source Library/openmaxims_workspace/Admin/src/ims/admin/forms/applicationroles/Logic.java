//#############################################################################
//#                                                                           #
//#  Copyright (C) <2015>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#  IMS MAXIMS provides absolutely NO GUARANTEE OF THE CLINICAL SAFTEY of    #
//#  this program.  Users of this software do so entirely at their own risk.  #
//#  IMS MAXIMS only ensures the Clinical Safety of unaltered run-time        #
//#  software that it builds, deploys and maintains.                          #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by John MacEnri using IMS Development Environment (version 1.20 build 40727.1400)
// Copyright (C) 1995-2004 IMS MAXIMS plc. All rights reserved.

package ims.admin.forms.applicationroles;

import ims.admin.vo.AppFormMenuActionsVo;
import ims.admin.vo.AppFormMenuActionsVoCollection;
import ims.admin.vo.AppFormVo;
import ims.admin.vo.AppNavFormVo;
import ims.admin.vo.AppNavRootGroupVo;
import ims.admin.vo.AppNavSecondGroupVo;
import ims.admin.vo.AppNavShortVoCollection;
import ims.admin.vo.AppNavigationVo;
import ims.admin.vo.AppRightVo;
import ims.admin.vo.AppRightVoCollection;
import ims.admin.vo.AppRoleShortVo;
import ims.admin.vo.AppRoleShortVoCollection;
import ims.admin.vo.AppRoleVo;
import ims.admin.vo.AppTopButtonConfigShortVoCollection;
import ims.admin.vo.FormMenuActionsDeniedVo;
import ims.admin.vo.FormMenuActionsDeniedVoCollection;
import ims.admin.vo.MenuActionVo;
import ims.admin.vo.MenuActionVoCollection;
import ims.admin.vo.RBACBaselineJobRoleLiteVo;
import ims.admin.vo.RBACBaselineJobRoleLiteVoCollection;
import ims.configuration.AppRight;
import ims.configuration.gen.ConfigFlag;
import ims.core.configuration.vo.AppFormRefVo;
import ims.core.vo.AlertAccessRightVo;
import ims.core.vo.AlertAccessRightVoCollection;
import ims.core.vo.lookups.AlertAccessRights;
import ims.core.vo.lookups.AlertAccessRightsCollection;
import ims.core.vo.lookups.AlertType;
import ims.core.vo.lookups.LookupHelper;
import ims.domain.exceptions.StaleObjectException;
import ims.domain.exceptions.UniqueKeyViolationException;
import ims.framework.Control;
import ims.framework.FormName;
import ims.framework.controls.DynamicGridCell;
import ims.framework.controls.DynamicGridColumn;
import ims.framework.controls.DynamicGridRow;
import ims.framework.controls.TreeNode;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.DynamicCellType;
import ims.framework.enumerations.FormMode;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.Color;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
public class Logic extends BaseLogic
{
	private static final int COL_ALERT = 1;
	private static final int COL_ACCESS = 2;
	
	@Override
	protected void onFormOpen() throws PresentationLogicException 
	{
		initialiseAlertRightGrid();
		populateNavCombo();
		populateTopButtonsCombo();
		populateSpineRBACCombo(); //WDEV-20420
		form.ccTaxonomyMappings().initialize();
		
		open();
		
		form.getContextMenus().getGenericGridRemoveItem().setVisible(false);
	}
	
	private void initialiseAlertRightGrid()
	{
		form.lyrRights().tabAlerts().dyngrdAlerts().clear();
		
		DynamicGridColumn colAlert = form.lyrRights().tabAlerts().dyngrdAlerts().getColumns().newColumn("Alert Category", COL_ALERT);
		colAlert.setWidth(270);
		colAlert.setCanGrow(true);
		
		DynamicGridColumn colAcess = form.lyrRights().tabAlerts().dyngrdAlerts().getColumns().newColumn("Alert Access Right", COL_ACCESS);
		colAcess.setWidth(-1);
	}
	
	@Override
	protected void onFormModeChanged() 
	{
		updateContextMenuState();		
		updateComponentState();
		
		//WDEV-15632
		form.btnUpdate().setVisible(form.getMode().equals(FormMode.VIEW));
		form.btnUpdate().setEnabled(false);
		
	}
	
	private void updateComponentState() 
	{	
		//WDEV-20420
		form.cmbSpineRBAC().setVisible(Boolean.TRUE.equals(form.chkRequiresPDS().getValue())); 
		form.cmbSpineRBAC().setEnabled(FormMode.EDIT.equals(form.getMode()));
		form.cmbSpineRBAC().setRequired(Boolean.TRUE.equals(form.chkRequiresPDS().getValue()) && FormMode.EDIT.equals(form.getMode())); 
		form.lblSpineRBAC().setVisible(Boolean.TRUE.equals(form.chkRequiresPDS().getValue())); 
		//WDEV-20420 ends here
		
		//WDEV-20617
		form.grdPdsRights().setVisible(Boolean.TRUE.equals(form.chkRequiresPDS().getValue())); 
		//form.grdPdsRights().setEnabled(FormMode.EDIT.equals(form.getMode()));
		form.btnAddPds().setVisible(Boolean.TRUE.equals(form.chkRequiresPDS().getValue()));
		form.btnAddPds().setEnabled(FormMode.EDIT.equals(form.getMode()));
		//WDEV-20617 ends here
		
		form.ccTaxonomyMappings().setMode(form.getMode());
		form.ccTaxonomyMappings().setComponentMode(form.getMode());
	}
	@Override
	protected void onTreActionsTreeViewSelectionChanged(TreeNode node) throws PresentationLogicException 
	{
		updateContextMenuState();		
	}
	@Override
	protected void onFormDialogClosed(FormName formName, DialogResult result) throws PresentationLogicException 
	{
		if(formName.equals(form.getForms().Admin.MenuActionsSelection) && result.equals(DialogResult.OK))
		{
			processMenuActionsSelection();
		}
		
		//WDEV-19693 
		if(formName.equals(form.getForms().Admin.AssignRightsDialog) && result.equals(DialogResult.OK))
		{
			 //WDEV-20617
			if (form.getLocalContext().getIsPdsRight())
				populateAppPdsRights(form.getGlobalContext().Admin.getSelectedPdsRoleRights());
			else	
				populateAppRights(form.getGlobalContext().Admin.getSelectedRoleRigths());
			 //WDEV-20617 ends here
		}
	}
	
	private void updateContextMenuState()
	{
		if(form.getMode() == FormMode.VIEW)
		{
			form.getContextMenus().Admin.getRoleMenuActionAddItem().setVisible(false);
			form.getContextMenus().Admin.getRoleMenuActionRemoveItem().setVisible(false);
			form.getContextMenus().Admin.getRoleMenuActionRemoveAllItem().setVisible(false);
			
			form.getContextMenus().Admin.getPdsRightsMenuActionsRemoveItem().setVisible(false);
		}
		else if(form.getMode() == FormMode.EDIT)
		{
			form.getContextMenus().Admin.getRoleMenuActionAddItem().setVisible(true);
			form.getContextMenus().Admin.getRoleMenuActionAddItem().setEnabled(true);
			form.getContextMenus().Admin.getRoleMenuActionRemoveItem().setVisible(form.lyrRights().tabActionsDenied().treActions().getValue() != null);
			form.getContextMenus().Admin.getRoleMenuActionRemoveAllItem().setVisible(true);
			form.getContextMenus().Admin.getRoleMenuActionRemoveAllItem().setEnabled(true);
			form.getContextMenus().Admin.getPdsRightsMenuActionsRemoveItem().setVisible(form.grdPdsRights().getValue() != null); //WDEV-20617
		}
		
		form.getContextMenus().Admin.getAlertsRightMenuADDItem().setVisible(FormMode.EDIT.equals(form.getMode()));
		form.getContextMenus().Admin.getAlertsRightMenuREMOVEItem().setVisible(FormMode.EDIT.equals(form.getMode()) && form.lyrRights().tabAlerts().dyngrdAlerts().getValue() != null);
	}
	
	private void populateNavCombo()
	{
		form.cmbNavs().clear();
		AppNavShortVoCollection coll = domain.listNavigations();
		for (int i = 0; i < coll.size(); i++)
		{
			form.cmbNavs().newRow( coll.get(i), coll.get(i).getNavigationName());
		}		
	}
	
	private void populateTopButtonsCombo()
	{
		form.cmbTopButtons().clear();
		AppTopButtonConfigShortVoCollection coll = domain.listTopButtonConfigurations();
		if(coll != null)
		{
			for (int i = 0; i < coll.size(); i++)
			{
				form.cmbTopButtons().newRow(coll.get(i), coll.get(i).getName());
			}
		}
	}
	
	//WDEV-20420
	private void populateSpineRBACCombo()
	{
		form.cmbSpineRBAC().clear();
		RBACBaselineJobRoleLiteVoCollection coll = domain.listSpineRBAC();
		
		if(coll != null)
		{
			for (RBACBaselineJobRoleLiteVo spine : coll)
			{
				form.cmbSpineRBAC().newRow(spine, spine.getRoleCode());
			}
		}
	}
	//WDEV-20420 ends here
	
	class AppRightComparator implements Comparator<AppRightVo>
	{

		public int compare(AppRightVo arg0, AppRightVo arg1) {
			
			return getText(arg0).compareToIgnoreCase(getText(arg1));
		}
		private String getText(AppRightVo vo)
		{
			
			if (vo == null || !vo.getNameIsNotNull())
				return "";
			return vo.getName();
		}
		
	}

	private void clearAllFields() 
	{
		form.chkIsActive().setValue(true);
		form.chkRequiresPDS().setValue(false); //WDEV-20420
		form.cmbSpineRBAC().setValue(null); // WDEV-20420
		form.grdPdsRights().getRows().clear(); //WDEV-20617
		form.txtRoleName().setValue(null);
		form.txtRoleDesc().setValue(null);
		form.cmbNavs().setValue(null);
		form.cmbTopButtons().setValue(null);
		form.ccTaxonomyMappings().clear();
		form.lyrRights().tabRightsGranted().grdRights().getRows().clear();
		form.lyrRights().tabAlerts().dyngrdAlerts().getRows().clear();
		form.treNavView().clear();
		form.lyrRights().tabActionsDenied().treActions().clear();
		form.intSessionTimeout().setValue(0);
		form.intAutolock().setValue(0);
	}

	private void listRoles() 
	{
		AppRoleShortVo selectedRole = form.getLocalContext().getRoleSelected();
		
		AppRoleShortVoCollection roles = domain.listRoles();		
		form.grdRoles().getRows().clear();
		GenForm.grdRolesRow row;
		for (int i = 0; i < roles.size(); i++)
		{
			AppRoleShortVo voRole = roles.get(i);
			if (selectedRole != null && selectedRole.getID_AppRoleIsNotNull() && selectedRole.getID_AppRole().equals(voRole.getID_AppRole()))
				row = form.grdRoles().getRows().newRow(true);
			else
				row = form.grdRoles().getRows().newRow();
			row.setValue(voRole);
			row.setcolRoleName(voRole.getName());	
		}
		
		// If the local context has a value set, set the grid value too
		if (form.getLocalContext().getRoleSelectedIsNotNull())
		{
			form.grdRoles().setValue(form.getLocalContext().getRoleSelected());
		}
	}

	protected void onBtnCancelClick() throws PresentationLogicException 
	{
		open();
	}

	private void open() 
	{
		form.setMode(FormMode.VIEW);
		clearAllFields();
		listRoles();		
		form.grdRoles().setEnabled(true);
		form.getContextMenus().getGenericGridRemoveItem().setVisible(false);
		form.getContextMenus().Admin.getPdsRightsMenuActionsRemoveItem().setVisible(false); //WDEV-20617
		
		if (form.getLocalContext().getRoleSelectedIsNotNull())
		{
			refreshSelectedRole();
		}
		updateComponentState(); //WDEV-20420
	}

	protected void onBtnSaveClick() throws PresentationLogicException 
	{
		if (!validateFields())
			return;
		
		AppRoleVo voRole = form.getLocalContext().getRoleSelected();
		
		AppNavigationVo navigation = domain.getNavigation(form.cmbNavs().getValue()); //WDEV-22749

		voRole.setIsActive(new Boolean(form.chkIsActive().getValue()));
		voRole.setRequiresPDS(form.chkRequiresPDS().getValue()); //WDEV-20420
		voRole.setSpineRbac(form.cmbSpineRBAC().getValue());//WDEV-20420
		voRole.setName(form.txtRoleName().getValue());
		voRole.setDescription(form.txtRoleDesc().getValue());
		voRole.setCodeMappings(form.ccTaxonomyMappings().getValue());
		voRole.setNavigation(navigation); //WDEV-22749
		voRole.setFormMenuActionsDenied(getActionsDenied());
		voRole.setSessionTimeout(form.intSessionTimeout().getValue());
		voRole.setAutolockTimer(form.intAutolock().getValue());


		
		if(form.cmbTopButtons().getValue() != null)
			voRole.setTopButtonConfig(domain.getTopButtonConfiguration(form.cmbTopButtons().getValue()));
		else
			voRole.setTopButtonConfig(null);
		
		voRole.setAppRights(buildAppRightList());
		voRole.setPdsRights(buildAppPdsRightList()); //WDEV-20617
		voRole.setAlertsAccess(populateAlertAccessRightsFromScreen());
		
		String[] errMess = voRole.validate(validateUIRules(navigation,voRole)); 
		if (errMess != null)
		{
			engine.showErrors(errMess);
			return;
		}
		
		try
		{	
			AppRoleVo newRole = domain.saveRole(voRole);
			form.getLocalContext().setRoleSelected(newRole);
		}
		catch (UniqueKeyViolationException e)
		{
			engine.showMessage(e.getMessage());
			return;
		}
		catch (StaleObjectException e)
		{
			engine.showMessage(ims.configuration.gen.ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			open();
			return;
		}
		
		open();
	}

	private String[] validateUIRules(AppNavigationVo navigation, AppRoleVo role)
	{
		List<String> uiErrors = new ArrayList<String>();
		
		for(int i=0; i<form.lyrRights().tabAlerts().dyngrdAlerts().getRows().size(); i++)
		{
			DynamicGridRow row = form.lyrRights().tabAlerts().dyngrdAlerts().getRows().get(i);
			
			if(row.getCells().get(getColumn(COL_ALERT)).getValue() != null && row.getCells().get(getColumn(COL_ACCESS)).getValue() == null)
			{
				uiErrors.add("Alert Access Right is mandatory.");
			}
			
			if(row.getCells().get(getColumn(COL_ALERT)).getValue() == null && row.getCells().get(getColumn(COL_ACCESS)).getValue() != null)
			{
				uiErrors.add("Alert Category is mandatory.");
			}
		}
		
		//WDEV-22749
		if (navigation != null && Boolean.FALSE.equals(navigation.getIsActive()) && Boolean.TRUE.equals(role.getIsActive()))
		{
			uiErrors.add("Selected navigation must be active.");
		}
		//WDEV-22749 ends here
		
		String[] uiResults = new String[uiErrors.size()];
		uiErrors.toArray(uiResults);
		
		return uiResults;
	}

	private AlertAccessRightVoCollection populateAlertAccessRightsFromScreen()
	{
		AlertAccessRightVoCollection coll = new AlertAccessRightVoCollection();
		
		for(int i=0; i<form.lyrRights().tabAlerts().dyngrdAlerts().getRows().size(); i++)
		{
			DynamicGridRow row = form.lyrRights().tabAlerts().dyngrdAlerts().getRows().get(i);
			
			AlertAccessRightVo alertAccess = null;
			
			if(row.getValue() instanceof AlertAccessRightVo)
			{
				alertAccess = (AlertAccessRightVo) row.getValue();
			}
			else
			{
				alertAccess = new AlertAccessRightVo();
			}
			
			alertAccess.setAlertType((AlertType) row.getCells().get(getColumn(COL_ALERT)).getValue());
			alertAccess.setAccess((AlertAccessRights) row.getCells().get(getColumn(COL_ACCESS)).getValue());
			
			if(alertAccess.getID_AlertAccessRight() == null && alertAccess.getAlertType() == null && alertAccess.getAccess() == null)
				continue;
			
			coll.add(alertAccess);
		}
		
		return coll;
	}

	private AppRightVoCollection buildAppRightList()
	{
		AppRightVoCollection ret = new AppRightVoCollection();
		int size = form.lyrRights().tabRightsGranted().grdRights().getRows().size();
		for (int i = 0; i < size; i++)
		{
			ret.add(form.lyrRights().tabRightsGranted().grdRights().getRows().get(i).getValue());
		}
		return ret;		
	}
	
	//WDEV-20617
	private AppRightVoCollection buildAppPdsRightList()
	{
		AppRightVoCollection ret = new AppRightVoCollection();
		int size = form.grdPdsRights().getRows().size();
		for (int i = 0; i < size; i++)
		{
			ret.add(form.grdPdsRights().getRows().get(i).getValue());
		}
		return ret;		
	}
	//WDEV-20617 ends here

	/**
	 * @return
	 */
	private boolean validateFields() 
	{
		if (form.txtRoleName().getValue() == null)
		{
			engine.showMessage("Please enter a Role Name.");
			return false;
		}
		
		if (form.intSessionTimeout().getValue() == null ||
				form.intSessionTimeout().getValue() < 0)
		{
			form.intSessionTimeout().setValue(0);
		}
		
		//WDEV-20420
		if (Boolean.TRUE.equals(form.chkRequiresPDS().getValue()) && form.cmbSpineRBAC().getValue() == null)
		{
			engine.showMessage("Please select a Job Role for SPINE-RBAC mapping.");
			return false;
		}
		//WDEV-20420 ends here
		
		if (form.intSessionTimeout().getValue() != null &&
				form.intSessionTimeout().getValue() > 0 &&
					ConfigFlag.GEN.SESSION_TIMEOUT.getValue() < form.intSessionTimeout().getValue())
		{
			engine.showMessage("'Session Timeout' value can't be greater than 'SESSION_TIMEOUT' ConfigFlag value (current value '" + ConfigFlag.GEN.SESSION_TIMEOUT.getValue() + "' minute(s) )");
			return false;
		}
		
		if (form.intAutolock().getValue() == null ||
				form.intAutolock().getValue() < 0)
		{
			form.intAutolock().setValue(0);
		}
		
		if (form.intAutolock().getValue() != null &&
				form.intAutolock().getValue() > 0 &&
					ConfigFlag.UI.AUTO_LOCK_TIMER.getValue() < form.intAutolock().getValue())
		{
			engine.showMessage("'Autolock Screen' value can't be greater than 'AUTO_LOCK_TIMER' ConfigFlag value (current value '" + ConfigFlag.UI.AUTO_LOCK_TIMER.getValue() + "' minute(s) )");
			return false;
		}
		
		return true;
	}

	protected void onBtnUpdateClick() throws PresentationLogicException 
	{
		form.setMode(FormMode.EDIT);
		form.grdRoles().setEnabled(false);
		form.getContextMenus().getGenericGridRemoveItem().setVisible(false);	
	//	populateAppRightsCombo(true);
	}

	
	protected void onBtnNewClick() throws PresentationLogicException 
	{
		form.getLocalContext().setRoleSelected(new AppRoleVo());
		form.setMode(FormMode.EDIT);
		clearAllFields();
		listRoles();
		form.grdRoles().setEnabled(false);
		form.getContextMenus().getGenericGridRemoveItem().setVisible(false);
		updateComponentState(); //WDEV-20420
	//	populateAppRightsCombo(false);
	}

	protected void onGrdRolesSelectionChanged() throws PresentationLogicException 
	{
		refreshSelectedRole();
	}

	private void refreshSelectedRole()
	{
		if (form.grdRoles().getValue() == null)
			return;
		AppRoleVo voRole = domain.getRole(form.grdRoles().getValue());
		form.getLocalContext().setRoleSelected(voRole);
		
		form.chkRequiresPDS().setValue(Boolean.TRUE.equals(voRole.getRequiresPDS())); //WDEV-20420
		form.cmbSpineRBAC().setValue(voRole.getSpineRbac()); //WDEV-20420
		updateComponentState(); //WDEV-20420
		
		form.txtRoleName().setValue(voRole.getName());
		form.txtRoleDesc().setValue(voRole.getDescription());
		form.chkIsActive().setValue(voRole.getIsActive().booleanValue());
		form.ccTaxonomyMappings().setValue(voRole.getCodeMappings());
		form.cmbNavs().setValue(voRole.getNavigation());
		form.cmbTopButtons().setValue(voRole.getTopButtonConfig());		
		form.intSessionTimeout().setValue(voRole.getSessionTimeoutIsNotNull() ? voRole.getSessionTimeout(): 0);
		form.intAutolock().setValue(voRole.getAutolockTimerIsNotNull() ?  voRole.getAutolockTimer() : 0);
		
		populateNavigation(voRole.getNavigation());
		form.btnUpdate().setEnabled(true);
		populateAppRights(voRole.getAppRights());
		populateAppPdsRights(voRole.getPdsRights()); //WDEV-20617
		populateMenuActions(voRole.getFormMenuActionsDenied());
		populateAlertsRightFromData(voRole.getAlertsAccess());
	}
	
	private void populateAlertsRightFromData(AlertAccessRightVoCollection alertsAccess)
	{
		form.lyrRights().tabAlerts().dyngrdAlerts().getRows().clear();
		
		if(alertsAccess == null)
			return;
		
		for(AlertAccessRightVo item : alertsAccess)
		{
			if(item == null)
				continue;
			
			DynamicGridRow row = form.lyrRights().tabAlerts().dyngrdAlerts().getRows().newRow();
			
			DynamicGridCell cell = row.getCells().newCell(getColumn(COL_ALERT), DynamicCellType.ENUMERATION);
			bindAlertTypeCell(cell);
			
			cell.setValue(item.getAlertType());
			deleteThisAlertFromAllAlertsItems(item.getAlertType(), cell);
			
			//WDEV-21078
			if (!Boolean.TRUE.equals(item.getAlertType().isActive()))
			{
				cell.getItems().newItem(item.getAlertType(), item.getAlertType().getText(), null , Color.Red);
				cell.setValue(item.getAlertType());
			}
			
			cell.setAutoPostBack(true);
			cell = row.getCells().newCell(getColumn(COL_ACCESS), DynamicCellType.ENUMERATION);
			bindAlertAccessRightCell(cell);
			cell.setValue(item.getAccess());
		
			row.setValue(item);
		}
	}
	
	private DynamicGridColumn getColumn(int colIden)
	{
		return form.lyrRights().tabAlerts().dyngrdAlerts().getColumns().getByIdentifier(colIden);
	}

	@SuppressWarnings("unchecked")
	private void populateNavigation(AppNavigationVo nav)
	{
		form.treNavView().clear();
		if (nav == null)
			return;
		
		for (int i = 0; i < nav.getRootGroups().size(); i++)
		{
			AppNavRootGroupVo rg = nav.getRootGroups().get(i);
			TreeNode rootNode = form.treNavView().getNodes().add(rg, rg.getGroupName());
			rootNode.setExpandedImage(form.getImages().Core.CareContext);
			rootNode.setCollapsedImage(form.getImages().Core.CareContext);
			rootNode.setSelectedImage(form.getImages().Core.CareContext);
					
			ArrayList<Object> children = new ArrayList<Object>();
			for (int j = 0; rg.getGroups() != null && j < rg.getGroups().size(); j++)
			{
				children.add(rg.getGroups().get(j));
			}
			for (int k = 0; rg.getForms() != null && k < rg.getForms().size(); k++)
			{
				children.add(rg.getForms().get(k));
			}
			Collections.sort(children, new NavComparator());
			
			for (int m = 0; m < children.size(); m++)
			{
				Object child = children.get(m);
				if (child instanceof AppNavSecondGroupVo)
				{
					addSecondGroup(rootNode, (AppNavSecondGroupVo)child, nav);
				}
				else
				{
					addNavForm(rootNode, (AppNavFormVo)child, nav);
				}
			}
		}
		form.treNavView().expandAll();
	}

	private void addSecondGroup(TreeNode rootNode, AppNavSecondGroupVo sg, AppNavigationVo nav)
	{
		TreeNode secNode = rootNode.getNodes().add(sg, sg.getGroupName());
		secNode.setExpandedImage(form.getImages().Core.CareSpell);
		secNode.setCollapsedImage(form.getImages().Core.CareSpell);
		secNode.setSelectedImage(form.getImages().Core.CareSpell);
			
		for (int k = 0; k < sg.getForms().size(); k++)
		{
			addNavForm(secNode, sg.getForms().get(k), nav);
		}
	}

	private void addNavForm(TreeNode parentNode, AppNavFormVo af, AppNavigationVo nav)
	{
		TreeNode formNode = parentNode.getNodes().add(af, af.getNodeText());
		if (af.isReadOnly())
		{
			formNode.setExpandedImage(form.getImages().Core.ViewDisabled);
			formNode.setCollapsedImage(form.getImages().Core.ViewDisabled);
			formNode.setSelectedImage(form.getImages().Core.ViewDisabled);	
		}
		else
		{
			formNode.setExpandedImage(form.getImages().Core.View);
			formNode.setCollapsedImage(form.getImages().Core.View);
			formNode.setSelectedImage(form.getImages().Core.View);				
		}
		if (af.getForm().equals(nav.getStartForm()))
		{
			if (af.isReadOnly())
			{
				formNode.setExpandedImage(form.getImages().Core.HomeDisabled);
				formNode.setCollapsedImage(form.getImages().Core.HomeDisabled);
				formNode.setSelectedImage(form.getImages().Core.HomeDisabled);	
			}
			else
			{
				formNode.setExpandedImage(form.getImages().Core.Home);
				formNode.setCollapsedImage(form.getImages().Core.Home);
				formNode.setSelectedImage(form.getImages().Core.Home);	
			}
		}
		else if (af.getForm().equals(nav.getPatientSearchForm()))
		{
			if (af.isReadOnly())
			{
				formNode.setExpandedImage(form.getImages().Core.FindDisabled16);
				formNode.setCollapsedImage(form.getImages().Core.FindDisabled16);
				formNode.setSelectedImage(form.getImages().Core.FindDisabled16);				
			}
			else
			{
				formNode.setExpandedImage(form.getImages().Core.FindEnabled16);
				formNode.setCollapsedImage(form.getImages().Core.FindEnabled16);
				formNode.setSelectedImage(form.getImages().Core.FindEnabled16);				
			}
		}
	}


	private void populateAppRights(AppRightVoCollection rights)
	{
		form.lyrRights().tabRightsGranted().grdRights().getRows().clear();
		if (rights == null)
			return;
		rights.sort(new AppRightComparator());
		GenForm.lyrRightsLayer.tabRightsGrantedContainer.grdRightsRow row;
		for (int i = 0; i < rights.size(); i++)
		{
			row = form.lyrRights().tabRightsGranted().grdRights().getRows().newRow();
			row.setAppRight(rights.get(i).getName());
			row.setValue(rights.get(i));
			
			//WDEV-20577
//			row.setTooltip(rights.get(i).getComment());
			AppRight right = AppRight.getRight(rights.get(i).getName());
			if (right != null)
				row.setTooltip(right.getComment()); //WDEV-20577
		
		}	
	}
	
	//WDEV-20617
	private void populateAppPdsRights(AppRightVoCollection rights)
	{
		form.grdPdsRights().getRows().clear();
		if (rights == null)
			return;
		rights.sort(new AppRightComparator());
		GenForm.grdPdsRightsRow row;
		for (int i = 0; i < rights.size(); i++)
		{
			row = form.grdPdsRights().getRows().newRow();
			row.setPDSRights(rights.get(i).getName());
			row.setValue(rights.get(i));
			row.setTooltip(rights.get(i).getComment());
		}	
	}
	//WDEV-20617 ends here

	protected void onContextMenuItemClick(int menuItemID, Control sender) throws PresentationLogicException 
	{		
		switch(menuItemID)
		{
			//WDEV-20617
			case GenForm.ContextMenus.AdminNamespace.PdsRightsMenuActions.Remove:
				form.grdPdsRights().removeSelectedRow();
				updateContextMenuState();
				break;
			//WDEV-20617 ends here
			case GenForm.ContextMenus.GenericGrid.Remove:
				form.lyrRights().tabRightsGranted().grdRights().removeSelectedRow();
				form.getContextMenus().getGenericGridRemoveItem().setVisible(false);
				break;
			case GenForm.ContextMenus.AdminNamespace.RoleMenuAction.Add:
				addMenuActionsDenied();
				break;
			case GenForm.ContextMenus.AdminNamespace.RoleMenuAction.Remove:
				removeMenuActionsDenied();
				break;
			case GenForm.ContextMenus.AdminNamespace.RoleMenuAction.RemoveAll:
				removeAllMenuActionsDenied();
				break;
				
			case GenForm.ContextMenus.AdminNamespace.AlertsRightMenu.ADD:
				addAlertRight();
			break;
			
			case GenForm.ContextMenus.AdminNamespace.AlertsRightMenu.REMOVE:
				removeAlertRight();
			break;
			
			default:
				break;
		}
	}

	private void removeAlertRight()
	{
		if(form.lyrRights().tabAlerts().dyngrdAlerts().getSelectedRow() == null)
			return;
		
		form.lyrRights().tabAlerts().dyngrdAlerts().getRows().remove(form.lyrRights().tabAlerts().dyngrdAlerts().getSelectedRow());
	}
	
	private void addAlertRight()
	{
		DynamicGridRow row = form.lyrRights().tabAlerts().dyngrdAlerts().getRows().newRow();
		
		DynamicGridCell cell = row.getCells().newCell(getColumn(COL_ALERT), DynamicCellType.ENUMERATION);
		bindAlertTypeCell(cell);
		cell.setAutoPostBack(true);
	
		cell = row.getCells().newCell(getColumn(COL_ACCESS), DynamicCellType.ENUMERATION);
		bindAlertAccessRightCell(cell);
	}

	private void bindAlertAccessRightCell(DynamicGridCell cell)
	{
		AlertAccessRightsCollection accessRightColl = LookupHelper.getAlertAccessRights(domain.getLookupService());
		
		if(accessRightColl == null)
			return;
		
		for(int i=0; i<accessRightColl.size(); i++)
		{
			if(accessRightColl.get(i) == null)
				continue;
			
			cell.getItems().newItem(accessRightColl.get(i), accessRightColl.get(i).getText());
		}
	}

	private void bindAlertTypeCell(DynamicGridCell cell)
	{
		ims.framework.cn.data.TreeNode[] alertsTypeColl = LookupHelper.getAlertType(domain.getLookupService()).getRootNodes();
		
		if(alertsTypeColl == null)
			return;
		
		cell.getItems().clear();
		
		for(int i=0; i<alertsTypeColl.length; i++)
		{
			if(!(alertsTypeColl[i] instanceof AlertType))
				continue;
			
			AlertType item = (AlertType)alertsTypeColl[i];
			
			if(item.isActive() && isNotAlreadyAdded(item))
			{
				cell.getItems().newItem(item, item.getText());
			}
		}
	}
	
	private void deleteThisAlertFromAllAlertsItems(AlertType alert, DynamicGridCell cellFromEvent)
	{
		for(int i=0; i<form.lyrRights().tabAlerts().dyngrdAlerts().getRows().size(); i++)
		{
			DynamicGridRow row = form.lyrRights().tabAlerts().dyngrdAlerts().getRows().get(i);
			DynamicGridCell cell = row.getCells().get(getColumn(COL_ALERT));
					
			Object value = cell.getValue();
			bindAlertTypeCell(cell);
			
			//WDEV-21078
			if (value!=null && value instanceof AlertType && !Boolean.TRUE.equals(((AlertType)value).isActive()))
			{
				AlertType item = (AlertType)value;
				cell.getItems().newItem(item, item.getText(), null, Color.Red);
			}
			
			cell.setValue(value);
		}
	}

	private boolean isNotAlreadyAdded(AlertType item)
	{
		if(item == null)
			return false;
		
		for(int i=0; i<form.lyrRights().tabAlerts().dyngrdAlerts().getRows().size(); i++)
		{
			DynamicGridRow row = form.lyrRights().tabAlerts().dyngrdAlerts().getRows().get(i);
			
			AlertType alert = (AlertType) row.getCells().get(getColumn(COL_ALERT)).getValue();
			
			if(item.equals(alert))
				return false;
		}
		
		return true;
	}
	
	protected void onGrdRightsSelectionChanged() throws PresentationLogicException
	{
		if (form.getMode().equals(FormMode.EDIT))			
			form.getContextMenus().getGenericGridRemoveItem().setVisible(true);
	}
	
	//WDEV-20617
	protected void onGrdPdsRightsSelectionChanged() throws PresentationLogicException 
	{
		updateContextMenuState();
	}
	//WDEV-20617 ends here
	
	protected void onBtnAddClick() throws PresentationLogicException
	{	
		form.getLocalContext().setIsPdsRight(false);
		form.getGlobalContext().Admin.setSelectedRoleRigths(form.lyrRights().tabRightsGranted().grdRights().getValues());
		engine.open(form.getForms().Admin.AssignRightsDialog, new Object[] {form.getLocalContext().getIsPdsRight()}); //WDEV-20617
	}
	
	//WDEV-20617
	protected void onBtnAddPdsClick() throws PresentationLogicException 
	{
		form.getLocalContext().setIsPdsRight(true);
		form.getGlobalContext().Admin.setSelectedPdsRoleRights(form.grdPdsRights().getValues());
		engine.open(form.getForms().Admin.AssignRightsDialog, new Object[] {form.getLocalContext().getIsPdsRight()});//WDEV-20617
	}
	//WDEV-20617 ends here
	
	protected void onCmbNavsValueChanged() throws PresentationLogicException
	{
		populateNavigation(domain.getNavigation(form.cmbNavs().getValue()));
	}

	private class NavComparator implements Comparator
	{
		public int compare(Object obj1, Object obj2)
		{
			int int1 = 0;
			int int2 = 0;
			if (obj1 instanceof AppNavSecondGroupVo)
				int1 = ((AppNavSecondGroupVo)obj1).getPositionIndex();
			else if (obj1 instanceof AppNavFormVo)
				int1 = ((AppNavFormVo)obj1).getPositionIndex();
			if (obj2 instanceof AppNavSecondGroupVo)
				int2 = ((AppNavSecondGroupVo)obj2).getPositionIndex();
			else if (obj2 instanceof AppNavFormVo)
				int2 = ((AppNavFormVo)obj2).getPositionIndex();
			
			if (int1 < int2)
				return -1;
			else if (int1 == int2)
				return 0;
			else
				return 1;
		}
	}
	private void addMenuActionsDenied()
	{	
		engine.open(form.getForms().Admin.MenuActionsSelection);
	}
	private void removeMenuActionsDenied()
	{		
		TreeNode selectedNode = form.lyrRights().tabActionsDenied().treActions().getSelectedNode();
		if(selectedNode != null)
		{
			if(selectedNode.getParent() == null)
			{
				form.lyrRights().tabActionsDenied().treActions().getNodes().remove(selectedNode);
			}
			else
			{
				selectedNode.getParent().getNodes().remove(selectedNode);
			}
		}
		
		updateContextMenuState(); //WDEV-15632
	}	
	private void removeAllMenuActionsDenied()
	{
		form.lyrRights().tabActionsDenied().treActions().clear();
		updateContextMenuState(); //WDEV-15632
	}
	private void processMenuActionsSelection()
	{
		AppFormMenuActionsVoCollection actions = form.getGlobalContext().Admin.getSelectedMenuActions();
		for(int x = 0; x < actions.size(); x++)
		{
			processMenuActionsSelection(actions.get(x));
		}
	}
	private void processMenuActionsSelection(AppFormMenuActionsVo formActions) 
	{
		int formID = formActions.getID_AppForm();
		for(int x = 0; x < formActions.getMenuActions().size(); x++)
		{
			addMenuAction(getAppForm(formID), formActions.getMenuActions().get(x));
		}
	}
	private TreeNode findOrCreateMenuActionFormNode(AppFormVo appForm)
	{
		TreeNode formNode = null;
		
		for(int x = 0; x < form.lyrRights().tabActionsDenied().treActions().getNodes().size(); x++)
		{
			if(appForm.equals(form.lyrRights().tabActionsDenied().treActions().getNodes().get(x).getValue()))
			{
				formNode = form.lyrRights().tabActionsDenied().treActions().getNodes().get(x);
				break;
			}
		}
		
		if(formNode == null)
		{
			String formName = appForm.getName();
			if(appForm.isAlias())
				formName += " (" + appForm.getAliasName() + ")";
			if(appForm.isDialog())
				formName += " - dialog";
			
			formNode = form.lyrRights().tabActionsDenied().treActions().getNodes().add(appForm, formName);
			formNode.setCollapsedImage(form.getImages().Core.Form);
			formNode.setExpandedImage(form.getImages().Core.Form);
		}
		
		return formNode;
	}
	private void addMenuAction(AppFormVo appForm, MenuActionVo vo) 
	{
		TreeNode treeNode = findOrCreateMenuActionFormNode(appForm);
		
		boolean exists = false;
		
		for(int x = 0; x < treeNode.getNodes().size(); x++)
		{
			if(vo.equals(treeNode.getNodes().get(x).getValue()))
			{
				exists = true;
				break;
			}
		}
		
		if(!exists)
		{
			TreeNode actionNode = treeNode.getNodes().add(vo, vo.getMenuActionDescription());
			actionNode.setCollapsedImage(form.getImages().Core.AnswerBox_NotAvailable);
			actionNode.setExpandedImage(form.getImages().Core.AnswerBox_NotAvailable);
		}
	}
	private AppFormVo getAppForm(int formID) 
	{		
		for(int x = 0; x < form.lyrRights().tabActionsDenied().treActions().getNodes().size(); x++)
		{
			if(form.lyrRights().tabActionsDenied().treActions().getNodes().get(x).getValue() instanceof AppFormVo)
			{
				AppFormVo formValue = (AppFormVo)form.lyrRights().tabActionsDenied().treActions().getNodes().get(x).getValue();
				if(formValue.getFormId() == formID)
					return formValue;
			}
		}
		
		return domain.getForm(new AppFormRefVo(formID, 0));
	}
	private FormMenuActionsDeniedVoCollection getActionsDenied()
	{
		FormMenuActionsDeniedVoCollection result = new FormMenuActionsDeniedVoCollection();
		
		for(int x = 0; x < form.lyrRights().tabActionsDenied().treActions().getNodes().size(); x++)
		{
			TreeNode formNode = form.lyrRights().tabActionsDenied().treActions().getNodes().get(x);			
			AppFormVo formValue = (AppFormVo)formNode.getValue();
			MenuActionVoCollection actions = new MenuActionVoCollection();
			
			for(int y = 0; y < formNode.getNodes().size(); y++)
			{
				TreeNode itemNode = formNode.getNodes().get(y);
				if(itemNode.getValue() != null)
				{
					actions.add((MenuActionVo)itemNode.getValue());
				}
			}
			
			if(actions.size() > 0)
			{
				FormMenuActionsDeniedVo item = new FormMenuActionsDeniedVo();
				item.setForm(formValue);
				item.setMenuActions(actions);
				
				result.add(item);
			}
		}
		
		return result;
	}
	private void populateMenuActions(FormMenuActionsDeniedVoCollection formMenuActionsDenied) 
	{
		form.lyrRights().tabActionsDenied().treActions().clear();
		
		if(formMenuActionsDenied != null)	
		{
			for (FormMenuActionsDeniedVo item : formMenuActionsDenied) 
			{
				addMenuActions(item);
			}
		}
	}
	private void addMenuActions(FormMenuActionsDeniedVo item) 
	{
		for(int x = 0; x < item.getMenuActions().size(); x++)
		{
			addMenuAction(getAppForm(item.getForm().getID_AppForm()), item.getMenuActions().get(x));
		}
	}

	@Override
	protected void onDyngrdAlertsRowSelectionChanged(DynamicGridRow row) throws PresentationLogicException
	{
		updateContextMenuState();
	}

	@Override
	protected void onDyngrdAlertsCellValueChanged(DynamicGridCell cell)
	{
		if(getColumn(COL_ALERT).equals(cell.getColumn()))
		{
			deleteThisAlertFromAllAlertsItems((AlertType) cell.getValue(), cell);
		}
	}

	//WDEV-20420
	@Override
	protected void onChkRequiresPDSValueChanged() throws PresentationLogicException 
	{
		if (Boolean.FALSE.equals(form.chkRequiresPDS().getValue()))
		{
			form.cmbSpineRBAC().setValue(null);
			form.grdPdsRights().getRows().clear(); //WDEV-20617
		}
		updateComponentState();
	}
	//WDEV-20420 ends here
}
